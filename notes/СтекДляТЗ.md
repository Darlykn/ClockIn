# Technical Specification: Employee Attendance System
**Date:** 2026-03-22  
**Version:** 1.0  
**Stack:** FastAPI (Python) + React (TypeScript) + PostgreSQL

## 1. Обзор решения (Solution Overview)
Веб-приложение для автоматизации сбора, хранения и анализа данных посещаемости сотрудников. Система парсит Excel-отчеты, нормализует данные, устраняет дубликаты и предоставляет интерактивные дашборды для аналитики.

Архитектура выбрана по принципу **"Simple & Robust"**:
*   **Backend:** Асинхронный Python (FastAPI) для высокой производительности ввода-вывода.
*   **Database:** PostgreSQL как единый источник истины с использованием мощных SQL-агрегаций.
*   **Frontend:** SPA на React с использованием Mantine UI для быстрой и эстетичной разработки интерфейса.

---

## 2. Стек технологий (Tech Stack)

### Backend
*   **Framework:** FastAPI (Python 3.11+)
*   **Server:** Uvicorn (ASGI)
*   **ORM:** SQLAlchemy 2.0 (Async) + Alembic (Migrations)
*   **Data Processing:** Pandas + Openpyxl (Excel parsing)
*   **Utils:**
    *   `thefuzz` — нечеткое сравнение строк (Fuzzy Logic) для нормализации ФИО.
    *   `pyotp` + `qrcode` — реализация 2FA (TOTP).
    *   `python-jose` — работа с JWT.

### Frontend
*   **Core:** React 18, TypeScript, Vite
*   **UI Kit:** Mantine v7 (Components, Hooks, Notifications, Dark Mode)
*   **State Management:** TanStack Query (React Query) v5
*   **HTTP Client:** Axios
*   **Charts:** Recharts или ECharts-for-React (Heatmaps, Line charts)
*   **Icons:** Tabler Icons

### Infrastructure & Database
*   **DB:** PostgreSQL 16
*   **Containerization:** Docker & Docker Compose
*   **Testing:** Pytest

---

## 3. Архитектура базы данных (Schema Design)

### Таблица `users` (Роли и Доступ)
| Field | Type | Description |
|---|---|---|
| `id` | UUID | PK |
| `username` | String | Логин |
| `password_hash` | String | Bcrypt hash |
| `role` | Enum | `admin`, `manager`, `employee` |
| `totp_secret` | String | Секрет для 2FA (Base32) |
| `full_name` | String | Нормализованное ФИО сотрудника |
| `is_active` | Bool | Статус блокировки |

### Таблица `attendance_logs` (Основной массив данных)
| Field | Type | Description |
|---|---|---|
| `id` | BigInt | PK |
| `employee_id` | UUID | FK -> users.id (ссылка на нормализованного сотрудника) |
| `raw_name` | String | Имя как было в Excel (для истории) |
| `event_time` | Timestamp | Время события |
| `event_type` | Enum | `entry` (вход), `exit` (выход) |
| `checkpoint` | String | Точка прохода (Турникет №1 и т.д.) |

**Constraints:**
*   `UNIQUE INDEX (employee_id, event_time, event_type, checkpoint)` — для дедупликации данных при повторной загрузке файлов.

### Таблица `import_history` (Журнал загрузок)
| Field | Type | Description |
|---|---|---|
| `id` | Int | PK |
| `filename` | String | Имя загруженного файла |
| `uploaded_by` | UUID | Кто загрузил |
| `uploaded_at` | Timestamp | Время загрузки |
| `status` | Enum | `success`, `partial`, `failed` |
| `logs` | JSONB | Детали: `{"total": 3500, "skipped": 5, "errors": [...]}` |

---

## 4. Реализация ключевого функционала

### A. Авторизация и 2FA
1.  **Login:** Проверка логина/пароля -> Проверка наличия `totp_secret`.
2.  **First Login:** Если секрета нет -> Генерация QR-кода на фронтенде -> Пользователь сканирует -> Вводит код -> Секрет сохраняется.
3.  **Session:** Выдача `Access Token` (жизнь 15 мин) и `Refresh Token` (HttpOnly Cookie, жизнь 24ч).
4.  **Auto-Logout:** Реализован через sliding expiration. Если пользователь неактивен 15 минут (нет запросов обновления токена), refresh-токен на сервере аннулируется или истекает время жизни куки.

### B. Загрузка Excel и Нормализация (Background Tasks)
Процесс обработки файла вынесен в `BackgroundTasks` FastAPI, чтобы не блокировать интерфейс.

1.  **Парсинг:** Pandas читает Excel.
2.  **Валидация:** Pydantic модель проверяет форматы дат и полей. Ошибочные строки собираются в список ошибок, но не останавливают весь процесс.
3.  **Нормализация ФИО (TheFuzz):**
    *   Входящее ФИО сравнивается с базой `users`.
    *   Если совпадение > 90% -> привязываем к существующему ID.
    *   Если совпадение < 90% -> создаем новую запись.
4.  **Дедупликация:**
    *   Используется `INSERT ... ON CONFLICT DO NOTHING` (SQLAlchemy).
    *   Это гарантирует, что при загрузке того же файла данные не задублируются.

### C. Расчет метрик (SQL Power)
Сложная аналитика выполняется на уровне БД для быстродействия:

*   **Опоздания:**
    ```sql
    SELECT count(*) FROM attendance_logs 
    WHERE event_type = 'entry' AND event_time::time > '09:00:00';
    ```
*   **Среднее время пребывания:**
    Агрегация разницы между `MIN(event_time)` и `MAX(event_time)` за один день для каждого сотрудника.

---

## 5. UI/UX Решения (Frontend)

*   **Dark/Light Theme:** Переключатель темы через `MantineProvider`.
*   **Calendar View:** Использование компонента календаря с кастомным рендером ячеек (`renderDay`). День окрашивается в зависимости от статуса (опоздание/прогул) на основе данных API.
*   **Feedback:** Всплывающие уведомления (Toasts) при завершении загрузки файла или ошибках валидации.
*   **Responsive:** Grid-layout адаптируется под Desktop и Tablet (скрытие боковой панели, перестройка графиков).

---

## 6. Структура проекта

```text
/
├── backend/
│   ├── app/
│   │   ├── api/          # Endpoints (Auth, Files, Stats)
│   │   ├── core/         # Config, Security
│   │   ├── db/           # Models, Sessions
│   │   ├── services/     # Business Logic (Excel parsing, Fuzzing)
│   │   └── main.py
│   ├── tests/
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── components/   # UI Components
│   │   ├── hooks/        # React Query Hooks
│   │   └── pages/        # Dashboard, Login, Admin
│   └── Dockerfile
├── docker-compose.yml
└── README.md
```

## 7. Инструкция по запуску

1.  Клонировать репозиторий.
2.  Создать `.env` файл (на основе `.env.example`).
3.  Запустить:
    ```bash
    docker-compose up --build
    ```
4.  Открыть браузер:
    *   Frontend: `http://localhost:5173`
    *   Swagger Docs: `http://localhost:8000/docs`
