# Architectural Decisions & Implementation Strategy
**Subject:** Rationale for Stack "Variant B" (FastAPI + Postgres + React)  
**Target:** Test Assignment (Employee Attendance System)

## 1. Оценка нагрузки и выбор асинхронности
**Контекст:** Входной файл содержит ~3600 строк (месячная статистика).
**Анализ:**
*   Для связки Pandas + PostgreSQL такой объем данных является тривиальным (обработка занимает доли секунды).
*   Внедрение тяжелых очередей задач (Celery/Redis) избыточно усложнит деплой и проверку задания.
**Решение:**
Использовать `FastAPI BackgroundTasks`. Это обеспечивает неблокирующий I/O (интерфейс не зависает при загрузке), выполняет требования ТЗ, но сохраняет архитектуру легковесной ("Monolithic MVP").

---

## 2. Реализация требований Backend (Python)

### A. Нормализация ФИО (Data Cleaning)
**Проблема:** В ТЗ указано наличие опечаток (напр. "Иванов И.И." vs "Иванов И. И.").
**Решение:** Использование библиотеки **`thefuzz`** (Fuzzy Logic).
*   При парсинге строки проверяем сходство имени с существующими в БД.
*   Если `similarity > 90%` — приводим к каноничному виду (ID существующего сотрудника).
*   Это предотвращает создание дублей сотрудников из-за лишних пробелов или опечаток в буквах.

### B. Дедупликация данных
**Проблема:** ТЗ требует уникальность связки `Время + Сотрудник + Событие + Точка`.
**Решение:** Database-level constraint.
1.  В БД создается `UNIQUE INDEX`.
2.  Используется стратегия **Bulk Insert** через SQLAlchemy:
    ```python
    stmt = insert(logs_table).values(data_rows)
    stmt = stmt.on_conflict_do_nothing(
        index_elements=['employee_id', 'event_time', 'event_type', 'checkpoint']
    )
    ```
*   *Преимущество:* Работает быстрее, чем проверка `SELECT` перед каждой вставкой, и гарантирует целостность данных на уровне БД.

### C. Автовыход (Security)
**Требование:** Выход через 15 минут неактивности.
**Решение:** Sliding Expiration.
*   Используем пару токенов (Access/Refresh).
*   Access живет короткое время.
*   При каждом активном действии пользователя (запрос к API) время жизни сессии продлевается.
*   Если запросов не было > 15 минут, сессия истекает, и сервер возвращает 401.

### D. Восстановление пароля через 2FA
**Специфика:** Нестандартный флоу без Email.
**Решение:** Реализация эндпоинта `/reset-password`.
*   Входные данные: `username` + `OTP код` (из приложения Authenticator).
*   Сервер проверяет валидность OTP кода относительно сохраненного секрета пользователя.
*   Если код верен — разрешает перезапись `password_hash`.

---

## 3. Решения Frontend (React + Mantine)

### A. Визуализация календаря (Status Day)
**Требование:** Окраска дней (Зеленый/Желтый/Красный).
**Решение:** Mantine `DatePicker` / `Calendar` с пропом `renderDay`.
*   Вместо тяжелого FullCalendar используется нативный компонент UI-библиотеки.
*   Логика окраски прокидывается через стиль ячейки в зависимости от данных, полученных с API (массив статусов на месяц).

### B. Графики и Тепловая карта
**Решение:** **ECharts for React**.
*   Наиболее мощная библиотека для реализации `Heatmap` (интенсивность проходов по часам), требуемой в ТЗ.
*   Для простых метрик (Pie/Bar chart) можно использовать встроенные возможности или Recharts.

### C. Управление состоянием (UX)
**Решение:** **TanStack Query (React Query)**.
*   Критически важен для демо-видео.
*   Позволяет показать красивые состояния загрузки (`isLoading`), обрабатывать ошибки и кэшировать данные без лишнего кода (useEffect).

---

## 4. Агрегация данных и Метрики

**Принцип:** "Push computation to the Database".
Не вычислять метрики (опоздания, переработки) циклами в Python. Использовать SQL.

**Пример (Топ опаздывающих):**
```sql
SELECT employee_id, COUNT(*) as late_count
FROM attendance_logs
WHERE event_type = 'entry' 
  AND event_time::time > '09:00:00' -- Условие опоздания
GROUP BY employee_id
ORDER BY late_count DESC
LIMIT 10;
```

---

## 5. Гарантии успешной сдачи (Success Factors)

1.  **Seed Data Script (Генератор данных):**
    *   Excel файл на 3600 строк — это хорошо, но для красивых графиков (особенно Heatmap и трендов за год) нужно больше данных.
    *   Написан скрипт, наполняющий базу синтетическими данными за 6 месяцев, чтобы на видео-демо интерфейс выглядел живым и наполненным.

2.  **Слоистая архитектура:**
    *   Четкое разделение: `Router` (HTTP) -> `Service` (Business Logic) -> `Repository` (DB).
    *   Логика парсинга Excel вынесена в отдельный сервис, а не лежит в контроллере.

3.  **Обработка частичных ошибок (Graceful Degradation):**
    *   Вместо падения с 500 ошибкой при одной битой дате в Excel:
        1.  Строка пропускается.
        2.  Ошибка записывается в JSON-лог в БД.
        3.  Пользователь получает отчет: "Успешно: 3590, Ошибок: 10".
